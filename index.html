<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Subamos Nuevos Recuerdos</title>
    <link rel="stylesheet" href="styles.css">
    <style>
        /* Estilos para el modal */
        .modal {
            display: none;
            position: fixed;
            z-index: 1;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.5);
            padding-top: 60px;
        }
        .modal-content {
            background-color: #fefefe;
            margin: 5% auto;
            padding: 20px;
            border: 1px solid #888;
            width: 80%;
        }
        .thumbnail {
            width: 100px;
            height: auto;
            margin: 5px;
            display: inline-block;
        }
        .mi-enlace {
            font-size: 48px;
            color: rgb(230, 230, 230);
            text-decoration: none;
            padding: 20px 30px;
            background-color: rgba(255, 255, 255, 0.2);
            border: 3px solid rgba(255, 255, 255, 0.6);
            border-radius: 8px;
            transition: all 0.3s ease;
            box-shadow: 0 0 20px rgba(255, 255, 255, 0.3);
            justify-content: center;
            align-items: center;
            display: flex;
        }
        .mi-enlace:hover {
            background-color: rgba(255, 255, 255, 0.5);
            border-color: rgba(255, 255, 255, 1);
            box-shadow: 0 0 25px rgba(255, 255, 255, 0.7);
        }
    </style>
</head>
<body>
    <h1>Subamos Nuevos Recuerdos</h1>

    <div class="button-container">
        <button class="b1" onclick="document.getElementById('fileInput').click()">Seleccionar Archivos</button>
        <input class="file-input" type="file" id="fileInput" multiple onchange="filesSelected()" style="display: none;">
        <button class="b1" onclick="uploadFiles()">Cargar</button>
        <button onclick="openDeleteMenu()" class="b1">Quitar Recuerdos</button>
    </div>
    
    <div id="message"></div>

    <div id="deleteModal" class="modal">
        <div class="modal-content">
            <h2>Eliminar Archivos</h2>
            <div id="fileThumbnails"></div>
            <button onclick="deleteSelectedFiles()">Eliminar Seleccionados</button>
            <button onclick="closeDeleteModal()">Cerrar</button>
        </div>
    </div>

    <script src="https://cdn.socket.io/4.0.0/socket.io.min.js"></script>
    <script>
        function showMessage(text) {
            const messageDiv = document.getElementById('message');
            messageDiv.innerText = text;
            messageDiv.classList.add('show');
            setTimeout(() => {
                messageDiv.classList.remove('show');
            }, 3000);
        }

        function filesSelected() {
            const fileInput = document.getElementById("fileInput");
            const files = fileInput.files;
            if (files.length > 0) {
                const fileNames = Array.from(files).map(file => file.name).join(', ');
                showMessage("Archivos seleccionados: " + fileNames);
            }
        }

        function uploadFiles() {
            const fileInput = document.getElementById('fileInput');
            const files = fileInput.files;
            if (files.length === 0) {
                showMessage('Por favor, selecciona archivos para cargar.');
                return;
            }

            const formData = new FormData();
            Array.from(files).forEach(file => {
                formData.append('files', file);
            });

            fetch('/upload', {
                method: 'POST',
                body: formData
            })
            .then(response => response.text())
            .then(data => {
                showMessage(data);
                fileInput.value = "";
            })
            .catch(error => {
                showMessage('Error al cargar los archivos.');
                console.error(error);
            });
        }

        function openDeleteMenu() {
            loadFilesForDeletion();
            document.getElementById('deleteModal').style.display = 'block';
        }

        function closeDeleteModal() {
            document.getElementById('deleteModal').style.display = 'none';
        }

        function loadFilesForDeletion() {
            const fileThumbnails = document.getElementById('fileThumbnails');
            fileThumbnails.innerHTML = '';

            fetch('/uploads')
            .then(response => response.json())
            .then(files => {
                files.forEach(file => {
                    const img = document.createElement('img');
                    img.src = '/uploads/' + file;
                    img.className = 'thumbnail';
                    img.dataset.file = file;
                    img.onclick = toggleFileSelection;
                    fileThumbnails.appendChild(img);
                });
            })
            .catch(error => console.error('Error loading files for deletion:', error));
        }

        function toggleFileSelection(event) {
            const img = event.target;
            img.classList.toggle('selected');
        }

        function deleteSelectedFiles() {
            const selectedFiles = document.querySelectorAll('.thumbnail.selected');
            const fileNames = Array.from(selectedFiles).map(img => img.dataset.file);

            if (fileNames.length === 0) {
                alert("Por favor, selecciona al menos un archivo para eliminar.");
                return;
            }

            fetch('/delete', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ fileName: fileNames[0] })
            })
            .then(response => response.text())
            .then(data => {
                showMessage(data);
                closeDeleteModal();
            })
            .catch(error => {
                alert("Error al eliminar el archivo.");
                console.error(error);
            });
        }

        // ConexiÃ³n a Socket.io
        const socket = io('http://localhost:3000');

        socket.on('newFile', fileName => {
            showMessage('Nuevo archivo cargado: ' + fileName);
        });

        socket.on('fileDeleted', fileName => {
            showMessage('Archivo eliminado: ' + fileName);
            loadFilesForDeletion();
        });
    </script>
</body>
</html>
